/**
 * This file is @generated by
 * src/roma/tools/api_plugin/tmpl/v8/app/hpp_romav8.tmpl. Do not edit.
 * Version: {{getVersion}}
 * Code Generator: {{getRomaGenerator}}
*/

/*
 * Copyright 2023 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

{{range $file := .Files}}
{{- $defineGuard := $file.Package | printf "%s_" | replace "." "_" | upper}}
#ifndef {{$defineGuard}}V8_H_
#define {{$defineGuard}}V8_H_

#include <memory>

#include "src/roma/config/function_binding_object_v2.h"
#include "src/roma/roma_service/romav8_app_service.h"
#include "src/util/status_macro/status_macros.h"
#include "{{$file.Name | trimSuffix (ext $file.Name)}}.pb.h"

#include "absl/functional/any_invocable.h"
#include "absl/status/status.h"
#include "absl/status/statusor.h"
#include "absl/strings/str_cat.h"
#include "absl/synchronization/notification.h"
#include "src/util/execution_token.h"

{{range $svc := .Services}}
{{- $svcopts := index $svc.Options "privacysandbox.apis.roma.app_api.v1.roma_svc_annotation"}}
{{- $svcName := printf "V8%s" $svc.Name -}}

namespace {{$svcopts.CppNamespace}} {

/*
 * service: {{$svc.FullName}}
 */
template <typename TMetadata = google::scp::roma::DefaultMetadata>
class {{$svcName}} final :
      public google::scp::roma::romav8::app_api::RomaV8AppService<TMetadata> {
 public:
  using AppService = google::scp::roma::romav8::app_api::RomaV8AppService<TMetadata>;
  using Config = typename AppService::Config;

 public:
   static absl::StatusOr<{{$svcName}}<TMetadata>> Create(Config config) {
    auto service = {{$svcName}}(std::move(config));
    PS_RETURN_IF_ERROR(service.Init());
    return service;
  }

  absl::Status Register(std::string_view jscode,
                        std::string_view code_version,
                        absl::Notification& notification,
                        absl::Status& notify_status) {
    return AppService::Register(
        absl::StrCat(roma_app_jscode, jscode),
        code_version,
        notification,
        notify_status);
  }

  constexpr std::string_view GetRomaJsCode() { return roma_app_jscode; }

  void Cancel(const google::scp::roma::ExecutionToken& token) {
    AppService::Cancel(token);
  }

{{- range $rpc := .MethodsWithOption "privacysandbox.apis.roma.app_api.v1.roma_rpc_annotation"}}
  {{- $pkg := $svcopts.CppNamespace | replace "." "::" | printf "::%s" }}
  {{- $reqType := $rpc.RequestType | replace "." "::" | printf "%s::%s" $pkg }}
  {{- $respType := $rpc.ResponseType | replace "." "::" | printf "%s::%s" $pkg }}
  /*
   * {{$rpc.Name}}
   * {{- $rpc.Description}}
   * request: {{$reqType}}
   * response: absl::StatusOr<std::unique_ptr<{{$respType}}>>
   */
  absl::StatusOr<google::scp::roma::ExecutionToken> {{$rpc.Name}}(
      absl::Notification& notification,
      const {{$reqType}}& request,
      absl::StatusOr<std::unique_ptr<{{$respType}}>>& response,
      TMetadata metadata = TMetadata()) {
    return AppService::Execute(
        notification,
        "{{$svcopts.RomaAppName}}.{{$rpc.Name}}Pb",
        request,
        response,
        std::move(metadata));
  }

  absl::StatusOr<google::scp::roma::ExecutionToken> {{$rpc.Name}}(
      absl::AnyInvocable<void(absl::StatusOr<{{$respType}}>)> callback,
      const {{$reqType}}& request,
      TMetadata metadata = TMetadata()) {
    return AppService::Execute(
        std::move(callback),
        "{{$svcopts.RomaAppName}}.{{$rpc.Name}}Pb",
        request,
        std::move(metadata));
  }

{{end}}
 private:
  explicit {{$svcName}}(Config config, const std::string& code_id = "{{$svcopts.CodeId}}")
    : AppService(std::move(config), code_id) {}

 inline static constexpr std::string_view roma_app_jscode = R"ROMA_APP_JSCODE(
@ROMA_APP_JSCODE@
)ROMA_APP_JSCODE";
};

}  // namespace {{$svcopts.CppNamespace}}
{{end}}

#endif  // {{$defineGuard}}V8_H_
{{end}}
